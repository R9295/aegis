<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Add Note  |  name_of_user</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->

      <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.30/css/uikit.min.css'>
    <link href="../static/css/add_note.css" type="text/css" rel="stylesheet">
    <link href="../static/css/common.css" type="text/css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/simplemde/1.11.2/simplemde.min.css">
  </head>
  <body>
  <!--nav inspired by  https://codepen.io/antoinevinial/pen/lnwyC-->
  <header>
      
      <ul class="nav uk-list" >
          <div style="padding-top: 5px;"></div>
          <li><a href="#">{{.user}}@Aegis</a></li>
          <li><a href="/view_notes">Home</a></li>
          <li><a href="/add_note">Add Note</a></li>
          <li><a href="/settings">Settings</a></li>
          <li><a href="/logout">Logout</a></li>
      </ul>
               <button class="toggle-nav">
          <span>></span>


      </button>
  </header>
        
    
    
    <br><br>
      
    <div class="uk-container uk-container-small">
      
    
    <div align="center">
      <label for="name">Title</label>
      <input type="text" id="name" class="uk-input uk-form-width-large">
      <br>
      <br>
      Tag:<input class="uk-input uk-form-width-medium" type="text" placeholder="None" id="tag">

    </div>
    <br><br>
    <div>
     
    
    <button class="uk-button uk-button-default" onclick="set_type('text')">Text</button>
    <button class="uk-button uk-button-default" onclick="set_type('audio')">Audio</button>
    <br><br>

    

     <div id="input_div">
        <br><br>
       <textarea name="" rows="15" id="input"></textarea>
      </div> 

      </div>
      <div id="input_audio">
        <button class="uk-button uk-button-primary" id="start">Start</button>
        <button class="uk-button uk-button-secondary" id="stop">Stop</button>
        <br><br>
        <br><br>
        <div id="player">
        Listen to your note:
            <audio src="" controls id="preview_player"></audio>
        </div>

      </div>


     
    </div>
    <div align="right">
    <br><br>
      <br><br>

    
    <button class="uk-button uk-button-primary" onclick="post_data()">Save</button>
    <button class="uk-button uk-button-default">Discard</button>
    </div>
    <br><br>
    </div>

    

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.30/js/uikit.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.30/js/uikit-icons.min.js'></script>
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/5.0.6/adapter.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplemde/1.11.2/simplemde.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.3/js.cookie.min.js"></script>
  <script>
  var recorder; // globally accessible
  var microphone
  var recorded_blob

  $(document).ready(function(){

    var header = $('header'),
            btn    = $('button.toggle-nav');

    btn.on('click', function(){
        header.toggleClass('active');
    });

});



$("#input_div").hide()
$("#preview_player").hide()
$("#player").hide()
$("#input_audio").hide()
var notetype = "none"

 
function note_type(notetype){
  if (notetype === 'text'){
    $("#input_div").show()
    $("#input_audio").hide()
  
}


  if (notetype === 'audio'){
    $("#input_div").hide()
    $("#input_audio").show()


    function captureMicrophone(callback) {
    if(typeof navigator.mediaDevices === 'undefined' || !navigator.mediaDevices.getUserMedia) {
        alert('This browser does not supports WebRTC getUserMedia API.');
        if(!!navigator.getUserMedia) {
            alert('This browser seems supporting deprecated getUserMedia API.');
        }
    }
    navigator.mediaDevices.getUserMedia({
        audio: true
    }).then(function(microphone) {
        callback(microphone);
    }).catch(function(error) {
        alert('Unable to capture your microphone. Please check console logs.');
        console.log(error);
    });
}

function stopRecordingCallback() {
    $("#player").show()
    $("#preview_player").show()
    microphone.stop();
    $("#preview_player").attr("src",URL.createObjectURL(recorder.getBlob()))
    console.log('')
    console.log('')
    window.recorded_blob = recorder.getBlob()
    console.log(window.recorded_blob)
}

$("#start").on('click',function() {
    if (!microphone) {
        captureMicrophone(function(mic) {
            microphone = mic;
            $("#start").click();
          });
        return;
    }
    recorder = RecordRTC(microphone, {
        recorderType: StereoAudioRecorder,
        numberOfAudioChannels: isEdge ? 1 : 2,
    });
    recorder.startRecording();
});
document.getElementById('stop').onclick = function() {
    recorder.stopRecording(stopRecordingCallback);
}

}


}

function set_type(notetype){
  window.notetype = notetype
  note_type(notetype)
} 

var simplemde = new SimpleMDE({
  element: document.getElementById("input"),
  spellChecker:false
});
 
//Gathering form data, and posting
function post_data(){
  //Note Type:
  notetype = window.notetype
    
    //If text
  if (notetype === 'text'){
      
      //set post data
      var data ={}
      data['note'] = simplemde.value()
      data['title'] = $("#name").val()
      data['type'] = notetype
      if ($("#tag").val() == ''){
        data['tag'] = 'None'
              }
      if ($("#tag").val() != ''){
        data['tag'] = $("#tag").val()
      }
      
        $.ajax({
        type: "POST",
        url: "/add_note",
        contentType: 'application/json',
        data: JSON.stringify(data),
        dataType: 'json',
        success: function success(data){
        UIkit.notification("<span uk-icon='icon: check'></span> Successfully added note");


  }
    

  });
}
  if (notetype == 'audio'){
          //set post data
      var data ={}
      data['note'] = window.recorded_blob
      data['title'] = $("#name").val()
      data['type'] = 'audio'

      if ($("#tag").val() == ''){
        data['tag'] = 'None'
              }
      if ($("#tag").val() != ''){
        data['tag'] = $("#tag").val()
      }
      console.log(JSON.stringify(data))
      
      //  $.ajax({
      //  type: "POST",
      //  url: "/add_note",
      //  contentType: 'application/json',
      //  data: JSON.stringify(data),
      //  dataType: 'json',
      //  success: function success(data){
      //  UIkit.notification("<span uk-icon='icon: check'></span> Successfully added note");


    //
  //});

  }
}
</script>
  </body>
</html>